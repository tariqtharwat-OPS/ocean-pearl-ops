rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // FUNCTIONS only (Server-side Enforcement)
    match /stock_balances/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // ONLY Cloud Functions (Admin SDK)
    }

    match /site_wallets/{unitId} {
      allow read: if request.auth != null;
      allow write: if false; // ONLY Cloud Functions
    }

    // ADMIN OVERRIDES
    function isAdmin() {
       return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ceo' ||
              request.auth.token.role == 'admin' ||
              request.auth.token.email == 'info@oceanpearlseafood.com';
    }

    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /items/{itemId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /raw_materials/{itemId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /finished_products/{itemId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    function isManager() {
       let data = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
       return isAdmin() || data.role_v2 == 'LOC_MANAGER';
    }

    function isOperator() {
       let data = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
       return isManager() || data.role_v2 == 'UNIT_OP';
    }

    match /partners/{partnerId} {
      allow read: if request.auth != null;
      allow write: if isOperator();
    }

    match /locations/{locationId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
      
      match /units/{unitId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
        
        match /stock/{stockId} {
           allow read: if request.auth != null;
           allow write: if false; 
        }
      }
    }

    match /admin_notifications/{notificationId} {
      allow read: if request.auth != null; 
      allow write: if false; 
    }

    match /audit_logs/{document=**} {
      allow read: if request.auth != null; 
      allow write: if false; 
    }

    match /transactions/{transactionId} {
      allow read: if request.auth != null;
      allow write: if false; // STRICT: ONLY Cloud Functions
    }

    match /site_wallets/{walletId} {
      allow read: if request.auth != null;
      allow write: if false; // STRICT: ONLY Cloud Functions
    }

    match /counters/{counterId} {
      allow read: if request.auth != null;
      allow write: if false; // STRICT: ONLY Cloud Functions
    }

    match /financial_requests/{requestId} {
      allow read: if request.auth != null;
      allow write: if false; // ONLY Cloud Functions
    }

    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // LOCATION EXPENSES MODULE
    match /expenses/{expenseId} {
      allow read, write: if request.auth != null;
    }
    match /vendors/{vendorId} {
      allow read, write: if request.auth != null;
    }
    match /expense_types/{typeId} {
      allow read, write: if request.auth != null;
    }
  }
}
